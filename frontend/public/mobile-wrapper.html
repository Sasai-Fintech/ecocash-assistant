<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoCash Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: #000;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
</head>
<body>
    <iframe id="app-iframe" src="http://localhost:3000"></iframe>
    
    <script>
        const iframe = document.getElementById('app-iframe');
        
        // Extract parameters from URL (simulating Flutter passing data)
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userId = urlParams.get('userId') || urlParams.get('user_id');
        const transactionId = urlParams.get('transactionId') || urlParams.get('transaction_id');
        const contextParam = urlParams.get('context');
        
        // Wait for iframe to load before sending messages
        iframe.addEventListener('load', function() {
            console.log('âœ… EcoCash Assistant loaded in iframe');
            
            // Wait a bit longer to ensure React and CopilotKit are fully initialized
            setTimeout(() => {
                // Send JWT token if provided via URL, otherwise use default for testing
                const tokenToSend = token ? decodeURIComponent(token) : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiZGVtb191c2VyIiwiZW1haWwiOiJkZW1vQGVjb2Nhc2guY29tIiwicm9sZSI6InVzZXIiLCJleHAiOjE3MzUwMDAwMDB9.dummySignatureForTestingOnly';
                const userIdToSend = userId ? decodeURIComponent(userId) : 'demo_user';
                
                const tokenMessage = {
                    type: 'SET_TOKEN',
                    token: tokenToSend,
                    userId: userIdToSend,
                    timestamp: Date.now()
                };
                
                iframe.contentWindow.postMessage(tokenMessage, '*');
                console.log('ðŸ“¤ JWT token sent to widget', token ? '(from URL)' : '(default for testing)');
                
                // Send context if provided
                if (contextParam) {
                    try {
                        const context = JSON.parse(decodeURIComponent(contextParam));
                        const contextMessage = {
                            type: 'SET_CONTEXT',
                            context: {
                                ...context,
                                channel: 'mobile',
                                timestamp: Date.now()
                            }
                        };
                        
                        iframe.contentWindow.postMessage(contextMessage, '*');
                        console.log('ðŸ“¤ Context sent to widget');
                    } catch (error) {
                        console.error('âŒ Error parsing context JSON:', error);
                    }
                }
                
                // Trigger transaction help if transaction ID provided
                // Wait longer to ensure CopilotKit is fully initialized
                if (transactionId) {
                    setTimeout(() => {
                        const transactionMessage = {
                            type: 'TRANSACTION_HELP',
                            transactionId: decodeURIComponent(transactionId),
                            timestamp: Date.now()
                        };
                        
                        iframe.contentWindow.postMessage(transactionMessage, '*');
                        console.log('ðŸ“¤ Transaction help triggered:', transactionMessage.transactionId);
                    }, 1500); // Increased delay to ensure CopilotKit is ready
                }
            }, 1000); // Increased initial delay
        });
        
        // Listen for messages from iframe (for future bidirectional communication)
        window.addEventListener('message', function(event) {
            // Security: In production, verify event.origin
            if (event.data && event.data.type === 'NAVIGATE') {
                console.log('ðŸ”— Navigation request from UI:', event.data);
                // In Flutter, this would trigger native navigation
            }
        });
    </script>
</body>
</html>
